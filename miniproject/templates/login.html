{% extends 'base.html' %}

{% block title %}Login | Campus Event Portal{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center position-relative overflow-hidden"
    style="min-height: 100vh; padding: 20px;">

    <!-- Ambient Background -->
    <div class="floating-shape shape-1" style="top: 15%; left: 15%; opacity: 0.15;"></div>
    <div class="floating-shape shape-2" style="bottom: 15%; right: 15%; opacity: 0.15;"></div>

    <!-- MAIN CARD -->
    <div class="login-wrapper glass-panel position-relative d-flex flex-column"
        style="z-index: 10; max-width: 420px; width: 100%; min-height: 580px; padding: 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">

        <!-- HEADER / TOP BAR SWITCH (GLASS UI) -->
        <div class="d-flex w-100 position-relative"
            style="background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.05);">

            <div class="flex-fill p-3 text-center cursor-pointer position-relative role-tab active" id="tab-student"
                onclick="switchRole('student')" style="transition: all 0.3s ease;">
                <i class="fas fa-user-graduate mb-1 d-block fs-5 drop-shadow-sm"></i>
                <span class="fw-bold small text-uppercase tracking-wide">Student</span>
            </div>

            <div class="flex-fill p-3 text-center cursor-pointer position-relative role-tab" id="tab-faculty"
                onclick="switchRole('faculty')" style="transition: all 0.3s ease;">
                <i class="fas fa-chalkboard-teacher mb-1 d-block fs-5 drop-shadow-sm"></i>
                <span class="fw-bold small text-uppercase tracking-wide">Faculty</span>
            </div>

            <!-- Sliding Indicator Glow -->
            <div class="position-absolute bottom-0 h-1 transition-all" id="tab-indicator"
                style="width: 50%; height: 3px; background: var(--accent-color); left: 0; transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 -2px 10px var(--accent-color);">
            </div>
        </div>

        <!-- BODY CONTENT -->
        <div class="p-4 flex-fill d-flex flex-column justify-content-center">

            <div class="text-center mb-5 mt-2">
                <h3 class="card-title mb-2 fw-bold text-white tracking-tight" id="login-title"
                    style="font-size: 1.75rem;">Student Portal</h3>
                <p class="text-secondary small" id="login-subtitle">Access your event dashboard</p>
            </div>

            {% if error %}
            <div class="alert alert-danger text-center py-2 mb-4 shadow-sm border-0 small rounded-3 backdrop-blur"
                style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.2);">
                <i class="fas fa-exclamation-circle me-1"></i> {{ error }}
            </div>
            {% endif %}
            {% if success %}
            <div class="alert alert-success text-center py-2 mb-4 shadow-sm border-0 small rounded-3 backdrop-blur"
                style="background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.2);">
                <i class="fas fa-check-circle me-1"></i> {{ success }}
            </div>
            {% endif %}

            <form method="POST" action="{{ url_for('auth.login') }}">

                <!-- ATTRACTIVE INPUT BOX 1 (USERNAME) -->
                <div class="mb-4 position-relative group">
                    <label
                        class="form-label text-secondary small text-uppercase fw-bold letter-spacing-1 ps-1 type-label"
                        id="label-username">Register Number</label>
                    <div class="input-group glass-input-group rounded-3 overflow-hidden transition-all">
                        <span class="input-group-text bg-transparent border-0 text-secondary ps-3"
                            style="min-width: 45px; justify-content: center;">
                            <i class="fas fa-id-card text-accent-muted fs-5" id="user-icon"></i>
                        </span>
                        <input type="text" name="username" id="input-username"
                            class="form-control border-0 bg-transparent text-white py-3 ps-2 shadow-none"
                            placeholder="Enter Register Number" required>
                    </div>
                </div>

                <!-- ATTRACTIVE INPUT BOX 2 (PASSWORD) -->
                <div class="mb-5 position-relative group">
                    <label
                        class="form-label text-secondary small text-uppercase fw-bold letter-spacing-1 ps-1 type-label">Password</label>
                    <div class="input-group glass-input-group rounded-3 overflow-hidden transition-all">
                        <span class="input-group-text bg-transparent border-0 text-secondary ps-3"
                            style="min-width: 45px; justify-content: center;">
                            <i class="fas fa-lock text-accent-muted fs-5"></i>
                        </span>
                        <input type="password" name="password"
                            class="form-control border-0 bg-transparent text-white py-3 ps-2 shadow-none"
                            placeholder="Enter Password" required>
                    </div>
                </div>

                <div class="d-flex justify-content-end mb-4" style="margin-top: -1.5rem;">
                    <a href="{{ url_for('auth.forgot_password') }}"
                        class="small text-decoration-none text-secondary hover-white transition-colors">
                        Forgot Password?
                    </a>
                </div>

                <div class="d-grid mb-3">
                    <button type="submit" class="btn btn-primary btn-lg shadow-lg position-relative overflow-hidden"
                        style="background: linear-gradient(135deg, var(--accent-color), #6366f1); border: none; font-weight: 600; padding: 12px;">
                        <span class="position-relative z-10"><i class="fas fa-sign-in-alt me-2"></i>Login
                            Securely</span>
                        <div class="absolute inset-0 bg-white opacity-0 hover-opacity-10 transition-opacity"></div>
                    </button>
                </div>

            </form>

            <!-- Registration Footer (Hidden for Faculty) -->
            <div class="text-center mt-auto pt-3 transition-opacity" id="register-footer">
                <p class="text-secondary small mb-2 opacity-75">New student?</p>
                <button onclick="openRegister()"
                    class="btn btn-sm rounded-pill px-4 text-white border border-secondary hover-border-accent hover-shadow bg-transparent transition-all">
                    <i class="fas fa-user-plus me-1"></i> Create Student Account
                </button>
            </div>
        </div>
    </div>

    <!-- SLIDE-UP REGISTRATION PANEL -->
    <div id="register-panel"
        class="glass-panel position-fixed start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center"
        style="top: 100%; transition: top 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 20; border-radius: 0; background: rgba(5, 5, 10, 0.95); backdrop-filter: blur(20px); overflow-y: auto;">

        <div class="container" style="max-width: 450px; padding: 2rem 1rem;">

            <button onclick="closeRegister()"
                class="btn btn-link text-secondary text-decoration-none position-absolute top-0 end-0 m-4 fs-5 hover-white transition-colors">
                <i class="fas fa-times me-1"></i> Close
            </button>

            <div class="text-center mb-5">
                <h3 class="card-title mb-2 fw-bold fs-2 text-white">Create Account</h3>
                <p class="text-secondary">Join the Campus Event Portal</p>
            </div>

            <form method="POST" action="{{ url_for('auth.register_user') }}">

                <!-- Forced Student Role -->
                <input type="hidden" name="role" value="student">

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary small fw-bold ps-1">Full Name</label>
                        <div class="input-group glass-input-group rounded-3">
                            <span class="input-group-text bg-transparent border-0 text-secondary ps-3"><i
                                    class="fas fa-user"></i></span>
                            <input type="text" name="name" class="form-control glass-input border-0 shadow-none ps-2"
                                placeholder="Full Name" required>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary small fw-bold ps-1">Email</label>
                        <div class="input-group glass-input-group rounded-3">
                            <span class="input-group-text bg-transparent border-0 text-secondary ps-3"><i
                                    class="fas fa-envelope"></i></span>
                            <input type="email" name="email" class="form-control glass-input border-0 shadow-none ps-2"
                                placeholder="Email Address" required>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label text-secondary small fw-bold ps-1">Department</label>
                    <div class="input-group glass-input-group rounded-3">
                        <span class="input-group-text bg-transparent border-0 text-secondary ps-3"><i
                                class="fas fa-building"></i></span>
                        <select name="department" class="form-select glass-input border-0 shadow-none ps-2" required>
                            <option value="" selected disabled>Select Department</option>
                            <option value="CSE">CSE</option>
                            <option value="IT">IT</option>
                            <option value="ECE">ECE</option>
                            <option value="EEE">EEE</option>
                            <option value="MECH">MECH</option>
                            <option value="CIVIL">CIVIL</option>
                        </select>
                    </div>
                </div>

                <!-- Student Fields Always Visible -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary small fw-bold ps-1">Register Number</label>
                        <div class="input-group glass-input-group rounded-3">
                            <span class="input-group-text bg-transparent border-0 text-secondary ps-3"><i
                                    class="fas fa-id-card"></i></span>
                            <input type="text" name="reg_no" class="form-control glass-input border-0 shadow-none ps-2"
                                placeholder="Register No" required>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary small fw-bold ps-1">Semester</label>
                        <div class="input-group glass-input-group rounded-3">
                            <span class="input-group-text bg-transparent border-0 text-secondary ps-3"><i
                                    class="fas fa-graduation-cap"></i></span>
                            <select name="semester" class="form-select glass-input border-0 shadow-none ps-2" required>
                                <option value="" selected disabled>Sem</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary small fw-bold ps-1">Password</label>
                        <div class="input-group glass-input-group rounded-3">
                            <span class="input-group-text bg-transparent border-0 text-secondary ps-3"><i
                                    class="fas fa-lock"></i></span>
                            <input type="password" name="password"
                                class="form-control glass-input border-0 shadow-none ps-2" placeholder="Password"
                                required>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label text-secondary small fw-bold ps-1">Confirm</label>
                        <div class="input-group glass-input-group rounded-3">
                            <span class="input-group-text bg-transparent border-0 text-secondary ps-3"><i
                                    class="fas fa-check-circle"></i></span>
                            <input type="password" name="confirm_password"
                                class="form-control glass-input border-0 shadow-none ps-2" placeholder="Confirm"
                                required>
                        </div>
                    </div>
                </div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-success btn-lg shadow-lg fw-bold"
                        style="background: linear-gradient(135deg, #10b981, #059669); border: none;">
                        <i class="fas fa-check me-2"></i> Register Student
                    </button>
                    <button type="button" onclick="closeRegister()" class="btn btn-link text-secondary mt-3 small">Back
                        to Login</button>
                </div>

            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    function switchRole(role) {
        // Update Tabs UI
        const indicator = document.getElementById('tab-indicator');
        const tabStudent = document.getElementById('tab-student');
        const tabFaculty = document.getElementById('tab-faculty');
        const footer = document.getElementById('register-footer');
        const userIcon = document.getElementById('user-icon');

        if (role === 'student') {
            indicator.style.left = '0';
            tabStudent.classList.add('active');
            tabFaculty.classList.remove('active');

            // Text Updates
            document.getElementById('login-title').innerText = "Student Portal";
            document.getElementById('login-subtitle').innerText = "Access your event dashboard";
            document.getElementById('label-username').innerText = "Register Number";
            document.getElementById('input-username').placeholder = "Enter Register Number";

            // Icon Update (ID Card for Student)
            userIcon.className = "fas fa-id-card text-accent-muted fs-5";

            // Show Register Option
            footer.style.display = 'block';
            setTimeout(() => footer.style.opacity = '1', 10);

        } else {
            indicator.style.left = '50%';
            tabFaculty.classList.add('active');
            tabStudent.classList.remove('active');

            // Text Updates
            document.getElementById('login-title').innerText = "Faculty Portal";
            document.getElementById('login-subtitle').innerText = "Manage events and attendance";
            document.getElementById('label-username').innerText = "Email Address";
            document.getElementById('input-username').placeholder = "Enter Email Address";

            // Icon Update (Envelope for Faculty)
            userIcon.className = "fas fa-envelope text-accent-muted fs-5";

            // Hide Register Option
            footer.style.opacity = '0';
            setTimeout(() => footer.style.display = 'none', 300);
        }
    }

    // REGISTRATION UI
    function openRegister() {
        document.getElementById('register-panel').style.top = '0';
    }

    function closeRegister() {
        document.getElementById('register-panel').style.top = '100%';
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.body.classList.add('login-bg');
        // Check for backend flag
        const showRegister = "{{ show_register|default(false)|tojson }}" === "true";
        if (showRegister) {
            setTimeout(openRegister, 100);
        }
    });
</script>

<style>
    /* Styling for glass inputs */
    .glass-input-group {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        transition: all 0.3s ease;
    }

    .glass-input-group:focus-within {
        background: rgba(15, 23, 42, 0.6);
        border-color: var(--accent-color) !important;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
    }

    .text-accent-muted {
        color: rgba(139, 92, 246, 0.6);
        transition: color 0.3s;
    }

    .glass-input-group:focus-within .text-accent-muted {
        color: var(--accent-color);
    }

    /* Role Tabs */
    .role-tab {
        color: rgba(255, 255, 255, 0.5);
    }

    .role-tab.active {
        color: #fff;
    }

    .role-tab:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    /* Registration Input Input Override */
    .glass-input {
        background: transparent !important;
        color: white !important;
    }

    /* Remove default form-control borders since we handle it in input-group */
    .form-control:focus,
    .form-select:focus {
        box-shadow: none !important;
        border-color: transparent !important;
    }

    /* Auto-fill fix for dark mode */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px #1c1a2e inset !important;
        -webkit-text-fill-color: white !important;
        transition: background-color 5000s ease-in-out 0s;
    }

    .hover-white:hover {
        color: white !important;
    }

    .hover-border-accent:hover {
        border-color: var(--accent-color) !important;
        color: var(--accent-color) !important;
    }

    .letter-spacing-1 {
        letter-spacing: 1px;
    }

    .drop-shadow-sm {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }
</style>
{% endblock %}